{
  "builders": [
    {
      "type": "virtualbox-iso",
      "vm_name": "{{user `template`}}",

      "format": "ova",
      "guest_os_type": "{{user `guest_os_type`}}",
      "boot_wait": "2m",
      "headless": true,

      "guest_additions_mode": "attach",
      "vboxmanage": [
        [
          "modifyvm",
          "{{.Name}}",
          "--memory",
          "4096"
        ],
        [
          "modifyvm",
          "{{.Name}}",
          "--cpus",
          "2"
        ],
        [
          "modifyvm",
          "{{.Name}}",
          "--videocapfile",
          "{{user `build_dir`}}/capture.webm"
        ],
        [
          "modifyvm",
          "{{.Name}}",
          "--videocap",
          "on"
        ]
      ],
      "vboxmanage_post": [
        [
          "modifyvm",
          "{{.Name}}",
          "--videocap",
          "off"
        ]
      ],

      "iso_url": "{{user `iso_url`}}",
      "iso_checksum": "md5:{{user `iso_checksum`}}",

      "host_port_max": 5985,
      "host_port_min": 5985,

      "communicator": "winrm",
      "winrm_timeout": "10h",
      "winrm_username": "vagrant",
      "winrm_password": "vagrant",

      "floppy_files": [
        "../../templates/{{user `template`}}/Autounattend.xml",
        "../../scripts/core/pspolicy.cmd",
        "../../scripts/core/boxstarter.install.ps1",
        "../../scripts/core/boxstarter.execute.ps1",
        "../../scripts/core/boxstarter.package.ps1",
        "../../scripts/core/startup-profile.ps1",
        "../../scripts/core/shutdown.ps1"
      ],

      "shutdown_command": "cmd.exe /c C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -File A:\\shutdown.ps1 {{user `shutdown_args`}}",
      "shutdown_timeout": "1h"
    }
  ],
  "post-processors": [
    {
      "output": "windows_{{user `template`}}_{{.Provider}}.box",
      "type": "vagrant",
      "vagrantfile_template": "../../templates/{{user `template`}}/vagrantfile.template"
    }
  ],
  "variables": {
    "build_dir": "{{env `PACKER_BUILD_DIR`}}",
    "shutdown_args": ""
  }
}
